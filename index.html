<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>El Metro más cercano</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

    <!-- Estilos de MapLibre GL (opensource, sin tokens) -->
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">

    <!-- Librerías externas necesarias -->
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>

    <style>
        /* Reset de márgenes y mapa en pantalla completa */
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }

        /* Marcador central en pantalla */
        .center-marker {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); 
            z-index: 10; 
            pointer-events: none; 
            width: 50px; 
            height: 50px;
        }

        /* Contenedor de botones personalizados */
        .map-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }

        /* Botón de geolocalización */
        .geolocate-btn {
            background: white;
            border: none;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            box-shadow: 0 0 4px rgba(0,0,0,0.3);
        }

        /* Ajuste del control default de MapLibre */
        .maplibregl-ctrl-top-left {
            top: 10px;
            left: 50px;
        }

        /* Logo inferior izquierdo */
        .map-logo {
            position: absolute;
            bottom: 30px;
            left: 30px;
            z-index: 1000; 
            opacity: 0.5; 
            transition: opacity 0.3s; 
        }
        .map-logo:hover { opacity: 0.9; }
        .map-logo img { width: 50px; height: auto; }

        /* Título superior */
        .map-title {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.5); 
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            font-size: 18px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        /* Logo inferior derecho */
        .metro-logo {
            position: absolute;
            bottom: 3%;
            left: 96%;
            z-index: 1000; 
            opacity: 0.5; 
            transition: opacity 0.3s; 
        }
        .metro-logo:hover { opacity: 0.9; }
    </style>
</head>
<body>
    <!-- Contenedor del mapa -->
    <div id="map"></div>

    <!-- Título del mapa -->
    <div class="map-title">
        Estaciones del Metro de la CDMX más cercanas a una ubicación
    </div>

    <!-- Marcador fijo en el centro -->
    <img src="./data/precision.png" class="center-marker" alt="Marcador central">

    <!-- Logo con enlace a mapa externo -->
    <div class="map-logo">
        <a href="https://alidrisi.carto.mx/spider-map-metro-metrobus/" target="_blank" rel="noopener noreferrer">
            <img src="./data/spider-map2.png" alt="Logo SpiderMap">
        </a>
    </div>

    <!-- Logo con enlace al mapa oficial del Metro de la CDMX -->
    <div class="metro-logo">
        <a href="https://www.metro.cdmx.gob.mx/la-red/mapa-de-la-red-con-calles" target="_blank" rel="noopener noreferrer">
            <img src="./data/metro_cdmx.png" alt="Mapa del Metro">
        </a>
    </div>       

<script>
/* --------------------------
   VARIABLES GLOBALES
--------------------------- */
let initLoad = true; // Controla si es la primera carga del mapa

/* --------------------------
   CONFIGURACIÓN DEL MAPA
--------------------------- */
const map = new maplibregl.Map({
    container: 'map', // ID del contenedor en el HTML
    style: {
        version: 8,
        glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
        sources: {
            'carto-dark': {
                type: 'raster',
                tiles: [
                    'https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',
                    'https://b.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',
                    'https://c.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png'
                ],
                tileSize: 256,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
            }
        },
        layers: [{
            id: 'carto-dark-layer',
            type: 'raster',
            source: 'carto-dark',
            minzoom: 0,
            maxzoom: 22
        }]
    }, // Estilo del mapa - CartoDB Dark Matter (opensource)
    center: [-99.133, 19.43], // Coordenadas iniciales (CDMX)
    zoom: 12, // Nivel de zoom inicial
    maxZoom: 18
});

/* --------------------------
   EVENTOS DEL MAPA
--------------------------- */
map.on('load', () => {
    let metro; // Variable para almacenar estaciones del metro (GeoJSON)

    // Se espera a que el mapa esté en "idle" (reposo inicial)
    map.once('idle', () => {
        // Carga de estaciones desde archivo externo
        d3.json("./data/metro.geojson", function (d) {
            metro = d;
            getSpoke(metro); // Calcula estaciones más cercanas al centro
        });

        // Al mover el mapa se recalculan estaciones cercanas
        map.on('move', () => {
            getSpoke(metro);
        });
    });
});

/* --------------------------
   FUNCIONES PRINCIPALES
--------------------------- */

/**
 * Obtiene las estaciones más cercanas al centro actual del mapa.
 */
function getSpoke(metro) {
    const center = map.getCenter(); // Centro actual del mapa
    const newPoint = turf.point([center.lng, center.lat]); // Convierte el centro en un "punto" GeoJSON
    buildSpoke(metro, newPoint);
}

/**
 * Construye las líneas y puntos de estaciones cercanas.
 */
function buildSpoke(metro, point) {
    let nearestmetro = turf.featureCollection([]);
    let nearestLines = turf.featureCollection([]);
    let cleanedmetro = JSON.parse(JSON.stringify(metro)); // Copia del dataset para ir eliminando

    // Encuentra las 5 estaciones más cercanas
    for (let i = 1; i <= 5; i++) {
        const nearest = turf.nearestPoint(point, cleanedmetro);

        // Ajuste de coordenadas en caso de cruce de hemisferios
        const startLng = point.geometry.coordinates[0];
        const endLng = nearest.geometry.coordinates[0];
        if (startLng >= 90 && endLng <= -90) {
            nearest.geometry.coordinates[0] += 360;
        } else if (startLng <= -90 && endLng >= 90) {
            nearest.geometry.coordinates[0] -= 360;
        }

        // Crea línea entre punto central y estación
        const nearestLine = turf.lineString([point.geometry.coordinates, nearest.geometry.coordinates]);

        nearestmetro.features.push(nearest);
        nearestLines.features.push(nearestLine);

        // Elimina estación ya usada para evitar duplicados
        const index = cleanedmetro.features.findIndex(n => n.properties.NOMBRE === nearest.properties.NOMBRE);
        if (index !== -1) cleanedmetro.features.splice(index, 1);
    }

    // Primera carga: agrega capas. Después: solo actualiza fuentes
    if (initLoad) {
        addLayers(metro, nearestmetro, nearestLines);
    } else {
        map.getSource('newPoint').setData(nearestmetro);
        map.getSource('newLine').setData(nearestLines);
    }
}

/**
 * Agrega capas de puntos y líneas al mapa (solo primera vez).
 */
function addLayers(metro, nearest, route) {
    initLoad = false;

    // Fuente con todas las estaciones
    map.addSource('points', { type: 'geojson', data: metro });

    // Fuente con las estaciones cercanas
    map.addSource('newPoint', { type: 'geojson', data: nearest });

    // Fuente con las líneas a estaciones cercanas
    map.addSource('newLine', { type: 'geojson', data: route });

    // Capa: líneas amarillas hacia estaciones cercanas
    map.addLayer({
        id: 'routeLayer',
        type: 'line',
        source: 'newLine',
        layout: { 'line-join': 'round', 'line-cap': 'round' },
        paint: {
            'line-color': '#e1e41e',
            'line-width': [
                'interpolate', ['linear'], ['zoom'],
                0, 0.5,
                3, 3
            ]
        }
    });

    // Capa: todos los puntos (estaciones del metro)
    map.addLayer({
        id: 'globe-points',
        type: 'circle',
        source: 'points',
        paint: {
            'circle-radius': ['interpolate', ['linear'], ['zoom'], 0, 0.1, 3, 3],
            'circle-opacity': 1,
            'circle-color': '#ff8402'
        }
    });

    // Capa: estaciones más cercanas (rojas)
    map.addLayer({
        id: 'globe-newPoint',
        type: 'circle',
        source: 'newPoint',
        paint: {
            'circle-radius': ['interpolate', ['linear'], ['zoom'], 0, 0.25, 3, 6],
            'circle-opacity': 1,
            'circle-color': '#ff0000'
        }
    });

    // Etiquetas con el nombre de estaciones cercanas
    map.addLayer({
        id: 'globe-newPoint-labels',
        type: 'symbol',
        source: 'newPoint',
        layout: {
            'text-field': ['get', 'NOMBRE'],
            'text-font': ['Open Sans Regular','Arial Unicode MS Regular'],
            'text-size': 13,
            'text-offset': [0, 0.5],
            'text-anchor': 'top'
        },
        paint: {
            'text-color': '#fd6060',
            'text-halo-color': '#000000',
            'text-halo-width': 1.2
        }
    });
}

/* --------------------------
   CONTROLES ADICIONALES
--------------------------- */
// Control de navegación (zoom y rotación)
map.addControl(new maplibregl.NavigationControl(), 'top-left');

// Control de geolocalización personalizado (sin dependencia de tokens)
map.addControl(
    new maplibregl.GeolocateControl({
        positionOptions: { enableHighAccuracy: true },
        trackUserLocation: true,
        showUserHeading: true
    }),
    'top-left'
);
</script>
</body>
</html>
